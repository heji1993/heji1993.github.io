

<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    
    <meta name="author" content="何机">
    
    <meta name="description" content="Ajax是现代Web应用程序开发的一项关键工具。它让你能想服务器异步发送和接收数据，然后用JavaScript解析。">
    
    <meta name="keywords" content="JavaScript,Ajax,异步请求, 何机的博客,何机,博客,blog,IT,技术">
    

    
    <link rel="alternative" href="atom.xml" title="何机的博客" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ajax | 何机的博客 · No pains,no gains</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script>
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    
    <meta name="baidu-site-verification" content="SzJ3MGdmeo" />


    <meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />


    <!--<meta name="baidu-site-verification" content="SzJ3MGdmeo" />-->
    <!--<meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />-->

</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://heji1993.github.io" title="何机的博客">何机的博客</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <!--<a class="max-width max-w300" title="No pains,no gains" href="/feelings">No pains,no gains</a>-->
						<a class="max-width max-w300" title="No pains,no gains">No pains,no gains</a>
                    </li>
                </ul>
                

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index">
                        <a href="/" target="">首页</a>
                    </li>
                    
                    <li id="nav-archives">
                        <a href="/archives" target="">归档</a>
                    </li>
                    
                    <li id="nav-categories">
                        <a href="/categories" target="">分类</a>
                    </li>
                    
                    <li id="nav-tags">
                        <a href="/tags" target="">标签</a>
                    </li>
                    
                    <li id="nav-about">
                        <a href="/about" target="">关于</a>
                    </li>
                    

                    <li id="nav-github"><a href="https://github.com/heji1993" target="_blank">GitHub</a></li>
                    <!--<li id="nav-rss"><a href="/atom.xml" target="_blank">Rss</a></li>-->
                    <li id="nav-search"><input type="text" id="search" placeholder="search" /></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
    var bgRoot = "http://7xkwt1.com1.z0.glb.clouddn.com/background-";
    var bgLength = "74";
    var bgRandom = false;
    var bgImage = "/images/bg.jpg";

    $(function() {
        // page-id...
        var pageId = "2016/12/28/Ajax/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";

        $("#nav-" + pageId).addClass("active");
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>Ajax</h1>

        <div class="time-info">
            
<span class="article-tags">
    
    Tags: <a href="/tags/JavaScript/">JavaScript</a>&nbsp;<a href="/tags/Ajax/">Ajax</a>&nbsp;<a href="/tags/web前端/">web前端</a>&nbsp;
</span>



<span class="article-categories">
    Category:
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
</span>


        </div>
        <div class="time-info">
            发表: <time datetime="2016-12-28T03:02:11.415Z"
                       itemprop="datePublished">2016-12-28</time>
            
            更新: <time datetime="2016-12-28T03:03:59.093Z"
                       itemprop="dateModified">2016-12-28</time>
            
        </div>

        <div class="post-body-inner">
            
                <div id="toc" class="toc-article well">
                    <strong class="toc-title">大纲</strong>
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ajax起步"><span class="toc-number">1.</span> <span class="toc-text">Ajax起步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Ajax事件"><span class="toc-number">2.</span> <span class="toc-text">使用Ajax事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理错误"><span class="toc-number">3.</span> <span class="toc-text">处理错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取和设置标头"><span class="toc-number">4.</span> <span class="toc-text">获取和设置标头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成跨源Ajax请求"><span class="toc-number">5.</span> <span class="toc-text">生成跨源Ajax请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中止请求"><span class="toc-number">6.</span> <span class="toc-text">中止请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发送表单数据"><span class="toc-number">7.</span> <span class="toc-text">发送表单数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#表单编码"><span class="toc-number">7.1.</span> <span class="toc-text">表单编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用FormData对象发送表单数据"><span class="toc-number">7.2.</span> <span class="toc-text">使用FormData对象发送表单数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发送文件"><span class="toc-number">8.</span> <span class="toc-text">发送文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#追踪文件上传进度"><span class="toc-number">8.1.</span> <span class="toc-text">追踪文件上传进度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求并处理不同内容类型（以JavaServlet为例）"><span class="toc-number">9.</span> <span class="toc-text">请求并处理不同内容类型（以JavaServlet为例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#response属性和responseType属性"><span class="toc-number">10.</span> <span class="toc-text">response属性和responseType属性</span></a></li></ol>
                </div>
            

            <p>Ajax是现代Web应用程序开发的一项关键工具。它让你能想服务器异步发送和接收数据，然后用JavaScript解析。</p>
<a id="more"></a>
<p>Ajax是异步JavaScript和XML的缩写，这个名称诞生于XML还是数据传输首选格式的时期，但现在基本不用XML传输数据了。<br>Ajax核心规范的名称继承于你用来建立和发起请求的JavaScript对象：XMLHttpRequest。这个规范有两个等级。所有浏览器都实现了第一级（Level1）。它代表了基础级别的功能。第二级别（Level2）扩展了最初的规范，纳入了额外的事件和一些功能来让它更容易与form元素协作，并且支持一些相关的规范（例如CORS）。</p>
<h3 id="Ajax起步"><a href="#Ajax起步" class="headerlink" title="Ajax起步"></a>Ajax起步</h3><p>Ajax的关键在于XMLHttpRequest对象，而理解这个对象的最佳方式就是看个例子。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span>&gt;</span>apples<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span>&gt;</span>bananas<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span>&gt;</span>cherries<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"target"</span>&gt;</span>Press a button<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="xml"></span></div><div class="line">            var buttons = document.getElementsByTagName("button");</div><div class="line">            for(var i = 0 ; i <span class="tag">&lt; <span class="attr">buttons.length</span> ; <span class="attr">i</span>++)&#123;</span></div><div class="line">                <span class="attr">buttons</span>[<span class="attr">i</span>]<span class="attr">.addEventListener</span>('<span class="attr">click</span>',<span class="attr">function</span>(<span class="attr">e</span>)&#123;</div><div class="line">                    //创建<span class="attr">XMLHttpRequest</span>对象</div><div class="line">                    <span class="attr">var</span> <span class="attr">httpRequest</span> = <span class="string">new</span> <span class="attr">XMLHttpRequest</span>();</div><div class="line">                    //给<span class="attr">readystatechange</span>事件设置一个事件处理器，这个事件会在请求过程中被多次触发，向你提供事情的进展情况</div><div class="line">                    <span class="attr">httpRequest.onreadystatechange</span> = <span class="string">handleResponse;</span></div><div class="line">                    //<span class="attr">open</span>指定<span class="attr">HTTP</span>方法和需要请求的<span class="attr">URL</span>，<span class="attr">open</span>(<span class="attr">method</span>,<span class="attr">url</span>,<span class="attr">async</span>,<span class="attr">user</span>,<span class="attr">password</span>);第三个参数指定是否异步,默认<span class="attr">true</span>，最后两个可选参数是应该给服务器的用户名和密码</div><div class="line">                    <span class="attr">httpRequest.open</span>("<span class="attr">GET</span>",<span class="attr">e.target.innerHTML</span>+"<span class="attr">.html</span>");</div><div class="line">                    //发送请求。因没有向服务器发送任何数据，所有没有参数可用</div><div class="line">                    <span class="attr">httpRequest.send</span>();</div><div class="line">                &#125;,<span class="attr">false</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="attr">function</span> <span class="attr">handleResponse</span>(<span class="attr">e</span>)&#123;</div><div class="line">                //<span class="attr">e.target</span>表示当前<span class="attr">XMLHttpRequest</span>对象</div><div class="line">                //读取<span class="attr">XMLHttpRequest</span>对象的<span class="attr">readyState</span>属性来确定当前处理的阶段。</div><div class="line">                <span class="attr">if</span>(<span class="attr">e.target.readyState</span>==<span class="string">XMLHttpRequest.LOADING</span> &amp;&amp; <span class="attr">e.target.status</span>==<span class="string">200)&#123;</span></div><div class="line">                    <span class="attr">document.getElementById</span>("<span class="attr">target</span>")<span class="attr">.innerHTML</span> = <span class="string">e.target.responseText;</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>处理响应<br>  一旦脚本调用了send方法，浏览器会在后台发送请求到服务器。因为请求实在后台处理的，所有Ajax依靠readystatechange事件来通知你这个请求的进展情况。当readystatechange事件被触发后，浏览器会把一个Event对象传递给指定的处理函数。Event对象的target属性会被设定为与此事件关联的XMLHttpRequest。<br>  可以读取<strong>XMLHttpRequest.readyState</strong>属性的值确定当前请求到了哪个阶段。下面是这个属性的值<br>  <table><thead><tr><th>值</th><th>数值</th><th>说明</th></tr></thead><tbody><tr><td>UNSENT</td><td>0</td><td>已创建XMLHttpRequest对象</td></tr><tr><td>OPENED</td><td>1</td><td>已调用open方法</td></tr><tr><td>HEADERS_RECEIVED</td><td>2</td><td>已收到服务器响应的标头</td></tr><tr><td>LOADING</td><td>3</td><td>已收到服务器响应</td></tr><tr><td>DONE</td><td>4</td><td>响应完成或已失败</td></tr></tbody></table><br>  DONE状态并不意味着请求成功，它只代表请求已完成。可以通过status属性获得HTTP状态码，它会返回一个数值（比如200表示成功）。只有结合readyState和status属性的值才能够确定某个请求的结果。<br>  <strong>responseText</strong>属性会返回一个字符串，代表从服务器上取回的数据</li>
<li>主流中的异类：应对Opera<br>  Opera浏览器的XMLHttpRequest标准实现得不太一样。<br>  第一个问题是readystatechange事件不会返回一个Event对象，这意味着要把XMLHttpRequest对象指派给一个全局变量。<br>  第二个问题是Opera没有在XMLHttpRequest对象上定义就绪状态的常量，这意味着<code>XMLHttpRequest.readyState==XMLHttpRequest.DONE</code>要修改为<code>XMLHttpRequest.readyState==4</code></li>
</ul>
<h3 id="使用Ajax事件"><a href="#使用Ajax事件" class="headerlink" title="使用Ajax事件"></a>使用Ajax事件</h3><p>现在，我们来详细地看看XMLHttpRequest对象支持的功能以及如何在你的请求中使用它们。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>事件类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>abort</td>
<td>在请求被中止时触发</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>error</td>
<td>在请求失败时触发</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>load</td>
<td>在请求成功完成时触发</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>loadend</td>
<td>在请求完成时触发，不管成功还是失败</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>loadstart</td>
<td>在请求开始时触发</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>progress</td>
<td>触发以提示请求的进度</td>
<td>ProgressEvent</td>
</tr>
<tr>
<td>readystatechange</td>
<td>在请求生命周期的不同阶段触发</td>
<td>Event</td>
</tr>
<tr>
<td>timeout</td>
<td>如果请求超时时则触发</td>
<td>ProgressEvent</td>
</tr>
</tbody>
</table>
<p>这些事件大多数会在请求的某一个特定点上触发。readystatechange和progress这两个事件是例外，它们可以多次触发以提供进度更新。<br>除了readystatechange（XMLHttpRequest规范Level 1）之外，表中展示的其他事件都定义于XMLHttpRequest规范Level 2。<br>调用这些事件时，浏览器会对readystatechange事件使用常规的Event对象，对其他事件则使用ProgressEvent对象。ProgressEvent对象定义了Event对象的所有成员，并增加了一些成员。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td>lengthComputable</td>
<td>如果能够计算数据流的总长度则返回true</td>
<td>布尔值</td>
</tr>
<tr>
<td>loaded</td>
<td>返回当前已载入的数据量</td>
<td>数值</td>
</tr>
<tr>
<td>total</td>
<td>返回可用的数据总量</td>
<td>数值</td>
</tr>
</tbody>
</table>
<p>下面是使用这些事件的一个综合例子：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"images/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">        table&#123;</div><div class="line">            margin:10px;</div><div class="line">            border-collapse: collapse;</div><div class="line">            float: left;</div><div class="line">        &#125;</div><div class="line">        th,td&#123;</div><div class="line">            padding: 4px;</div><div class="line">        &#125;</div><div class="line">        div&#123;</div><div class="line">            margin: 10px;</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>apples<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>cherries<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>bananas<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"target"</span>&gt;</span></div><div class="line">        加载内容</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span>=<span class="string">"events"</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line">        //使用XMLHttpRequest定义的一次性事件</div><div class="line">        var buttons=document.getElementsByTagName("button");</div><div class="line">        for(var i=0;i&lt;buttons.length;i++)&#123;</div><div class="line">            buttons[i].onclick=handleButtonPress;</div><div class="line">        &#125;</div><div class="line">        var httpRequest;</div><div class="line">        function handleButtonPress(e)&#123;</div><div class="line">            clearEventDetails();</div><div class="line">            httpRequest=new XMLHttpRequest();</div><div class="line">            httpRequest.onreadystatechange=handleResponse;</div><div class="line">            httpRequest.onerror=handleError;</div><div class="line">            httpRequest.onload=handleLoad;</div><div class="line">            httpRequest.onloadend=handleLoadEnd;</div><div class="line">            httpRequest.onloadstart=handleLoadStart;</div><div class="line">            httpRequest.onprogress=handleProgress;</div><div class="line">            httpRequest.open("GET", e.target.innerHTML+".html");</div><div class="line">            httpRequest.send();</div><div class="line">        &#125;</div><div class="line">        function handleResponse(e)&#123;</div><div class="line">            displayEventDetails("readystate("+ httpRequest.readyState +")");</div><div class="line">            //处理响应</div><div class="line">            if(httpRequest.readyState==4 &amp;&amp; httpRequest.status==200)&#123;</div><div class="line">                document.getElementById("target").innerHTML= httpRequest.responseText;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        function handleError(e)&#123;displayEventDetails("error",e);&#125;</div><div class="line">        function handleLoad(e)&#123;displayEventDetails("load",e);&#125;</div><div class="line">        function handleLoadEnd(e)&#123;displayEventDetails("loadend",e);&#125;</div><div class="line">        function handleLoadStart(e)&#123;displayEventDetails("loadstart",e);&#125;</div><div class="line">        function handleProgress(e)&#123;displayEventDetails("progress",e);&#125;</div><div class="line">        function clearEventDetails()&#123;</div><div class="line">            document.getElementById("events").innerHTML="&lt;tr&gt;&lt;th&gt;Event&lt;/th&gt;&lt;th&gt;lengthComputable&lt;/th&gt;&lt;th&gt;loaded&lt;/th&gt;&lt;th&gt;total&lt;/th&gt;&lt;/tr&gt;"</div><div class="line">        &#125;</div><div class="line">        function displayEventDetails(eventName,e)&#123;</div><div class="line">            if(e)&#123;</div><div class="line">                document.getElementById("events").innerHTML+="&lt;tr&gt;&lt;td&gt;"+eventName+"&lt;/td&gt;&lt;td&gt;"+ e.lengthComputable+"&lt;/td&gt;&lt;td&gt;"+ e.loaded+"&lt;/td&gt;&lt;td&gt;"+ e.total+"&lt;/td&gt;&lt;/tr&gt;";</div><div class="line">            &#125;else&#123;</div><div class="line">                document.getElementById("events").innerHTML+="&lt;tr&gt;&lt;td&gt;"+eventName+"&lt;/td&gt;&lt;td&gt;NA&lt;/td&gt;&lt;td&gt;NA&lt;/td&gt;&lt;td&gt;NA&lt;/td&gt;&lt;/tr&gt;";</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h3><p>使用Ajax时必须留心两类错误。它们之间的区别源于视角不同。<br>第一类错误是从XMLHttpRequest对象的角度看到的问题：某些因素阻止了请求发送到服务器，例如DNS无法解析主机名或者URL无效等。<br>第二类问题是从应用程序的角度看到的问题。它们发生于请求成功发送到服务器，服务器接收请求，进行处理并生成相应，但该响应不是你期望的内容。例如请求的URL不存在等。</p>
<ul>
<li>处理设置错误<br>  使用try…catch语句来围住请求的代码。在catch子句对错误进行处理</li>
<li>处理应用程序错误<br>  这种错误发生于请求成功完成（从XMLHttpRequest对象角度看），但没有返回你想要的数据时，可以根据status属性来确定发生了什么。200表示请求成功完成。  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">if</span>(e.target.status==<span class="number">200</span>)&#123;</div><div class="line">        target.innerHTML = e.target.responseText;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">"Status:"</span>+e.target.status+<span class="string">","</span>+e.target.statusText);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="获取和设置标头"><a href="#获取和设置标头" class="headerlink" title="获取和设置标头"></a>获取和设置标头</h3><p>XMLHTTPRequest对象让你可以设置发送给服务器的请求标头（Header）和读取服务器响应里的标头。通常不需要添加或修改Ajax请求里的标头。浏览器知道需要发送什么，服务器也知道如何进行响应。不过，有几种情况是例外。<br>下面是有关标头的方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
<th>返回</th>
</tr>
</thead>
<tbody>
<tr>
<td>setRequestHeader(header,value)</td>
<td>用指定值设置标头</td>
<td>void</td>
</tr>
<tr>
<td>getResponseHeader(header)</td>
<td>获取指定标头的值</td>
<td>字符串</td>
</tr>
<tr>
<td>getAllResponseHeaders()</td>
<td>以单个字符串的形式获取所有的标头</td>
<td>字符串</td>
</tr>
</tbody>
</table>
<ul>
<li><p>覆盖请求的HTTP方法<br>  HTTP发送请求的方法除了GET和POST之外，还存在一些其他方法（比如PUT、DELETE）这些方法用来向服务器请求的URL赋予意义，而且这种用法正在呈现上升趋势。例如，如果想删除数据，可以这么写：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">    httpRequest.open(<span class="string">"DELETE"</span>,<span class="string">"http://myserver/records/person/1"</span>);</div></pre></td></tr></table></figure>
<p>  此处的关键在于通过HTTP方法表达出你想让服务器做什么，而不是把它用某种方式编码进URL。这是一种被称为RESTful API的趋势的一部分。<br>  以这种方式使用HTTP方法的问题在于：许多主流浏览器只支持GET和POST。而且不少防火墙只允许GET和POST请求通过。有一种惯用的做法可以规避这个限制，就是使用X-HTTP-Method-Override标头来指定想要使用的HTTP方法，但形式上是再发送一个POST请求(两个请求，第一个是OPTIONS请求，第二个是POST请求)。下面是示例代码:</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handleButtonPress</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> httpRequest = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">        httpRequest.onreadystatechange = handleResponse;</div><div class="line">        httpRequest.open(<span class="string">"GET"</span>,e.target.innerHTML+<span class="string">".html"</span>);</div><div class="line">        <span class="comment">//注意：一定要在open方法之后设置，否则会报错</span></div><div class="line">        httpRequest.setRequestHeader(<span class="string">"X-HTTP-Method-Override"</span>,<span class="string">"DELETE"</span>);</div><div class="line">        httpRequest.send();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>  <strong>注意：覆盖HTTP方法需要服务器端的Web应用程序框架能理解X-HTTP-Method-Override这个惯例，且能理解和支持那些用得较少的HTTP方法。对于Servlet，为支持X-HTTP-Method-Override，需要给响应添加一个标头<code>resp.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;X-HTTP-Method-Override&quot;);</code>以及重写<code>doOptions</code>方法</strong></p>
</li>
<li><p>禁用内容缓存<br>  第二个可以添加到Ajax请求上的有用标头是Cache-Control。一些浏览器会缓存通过Ajax请求所获得的内容，导致若请求的内容发生改变时，不能立刻反映到页面上。可以设置Cache-Control标头让浏览器不缓存Ajax请求获取的内容。例如：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handleButtonPress</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> httpRequest = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">        httpRequest.onreadystatechange = handleResponse;</div><div class="line">        httpRequest.open(<span class="string">"GET"</span>,e.target.innerHTML+<span class="string">".html"</span>);</div><div class="line">        <span class="comment">//注意：一定要在open方法之后设置，否则会报错</span></div><div class="line">        httpRequest.setRequestHeader(<span class="string">"Cache-Control"</span>,<span class="string">"no-cache"</span>);</div><div class="line">        httpRequest.send();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>获取响应标头<br>  可以通过getResponseHeader和getAllResponseHeaders方法来读取服务器响应某个Ajax请求时发送的HTTP标头。大多数情况下，不需要关心标头里有什么，因为它们是浏览器和服务器之间交互事务的组成部分。下面是例子：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(httpRequest.readyState == <span class="number">2</span>)&#123;</div><div class="line">           <span class="built_in">console</span>.log(httpRequest.getAllResponseHeaders);</div><div class="line">           <span class="built_in">console</span>.log(httpRequest.getResponseHeader(<span class="string">"Content-Type"</span>));</div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(httpRequest.readyState == <span class="number">4</span> &amp;&amp; httpRequest.status == <span class="number">200</span>)&#123;</div><div class="line">        <span class="comment">//成功完成响应的处理</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>  响应标头在readyState变成HEADERS_RECEIVED(值为2)时就可以使用了。标头是服务器在响应时首先发送回来的消息，因此可以在内容本身就绪前先读取它们。</p>
</li>
</ul>
<h3 id="生成跨源Ajax请求"><a href="#生成跨源Ajax请求" class="headerlink" title="生成跨源Ajax请求"></a>生成跨源Ajax请求</h3><p>默认情况下，浏览器限制脚本在它们所属文档的来源内生成Ajax请求，来源由URL中的协议、主机名和端口号组成。从一个来源到另一个来源的Ajax请求被称为跨源请求。浏览器不支持Ajax请求跨源的目的是降低跨站脚本攻击（Cross-site scripting，简称CSS）的风险。<br>为实现跨源请求，服务器返回浏览器的响应信息添加一个标头（这里以Java的Servlet示例）：<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//允许跨源请求</span></div><div class="line">        resp.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"http://127.0.0.1:8030"</span>);</div><div class="line">        <span class="comment">//支持X-HTTP-Method-Override请求头</span></div><div class="line">        resp.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"X-HTTP-Method-Override"</span>);</div></pre></td></tr></table></figure></p>
<ul>
<li><p>使用Origin请求标头<br>  作为CORS的一部分，浏览器会给请求添加一个Origin标头以注明当前文档的来源。可以通过它更灵活地设置Access-Control-Allow-Origin的值：</p>
  <figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    String origin = req.getHeader(<span class="string">"Origin"</span>);</div><div class="line">        <span class="comment">//如果是来源包含127.0.0.1</span></div><div class="line">        <span class="keyword">if</span>(origin.indexOf(<span class="string">"127.0.0.1"</span>)&gt;-<span class="number">1</span>)&#123;</div><div class="line">            <span class="comment">//允许跨源请求</span></div><div class="line">            resp.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, origin);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//支持X-HTTP-Method-Override请求头</span></div><div class="line">        resp.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"X-HTTP-Method-Override"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>高级CORS功能</p>
</li>
</ul>
<h3 id="中止请求"><a href="#中止请求" class="headerlink" title="中止请求"></a>中止请求</h3><p>XMLHttpRequest对象定义了一个让你可以中止请求的方法。如下表：</p>
<table>
<thead>
<tr>
<th>成员</th>
<th>说明</th>
<th>返回</th>
</tr>
</thead>
<tbody>
<tr>
<td>abort()</td>
<td>中断当前请求</td>
<td>void</td>
</tr>
</tbody>
</table>
<p>注意，当调用abort()方法时会触发XMLHttpRequest的onabort事件，可以在onabort事件里进行一些中断请求后的处理。</p>
<h3 id="发送表单数据"><a href="#发送表单数据" class="headerlink" title="发送表单数据"></a>发送表单数据</h3><p>Ajax最常见的一大用途是向服务器发送数据。最典型的情况是从客户端发送表单数据<br><img src="index_files/203b97a6-5332-4cb6-b4ff-e0104fcade3a.jpg" alt=""></p>
<h4 id="表单编码"><a href="#表单编码" class="headerlink" title="表单编码"></a>表单编码</h4><p><code>Content-Type</code>指定向服务器发送的数据格式，等价于表单元素的<code>enctype</code>属性。</p>
<ul>
<li><p><code>application/x-www-form-urlencoded</code>格式编码<br>  <code>application/x-www-form-urlencoded</code>是表单编码的默认格式。但由于不是Ajax编码的默认格式，所以需要手动指定。例如，下面有个表单：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">&lt;!--这是默认编码，可省略--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span>  <span class="attr">method</span>=<span class="string">'post'</span> <span class="attr">enctype</span>=<span class="string">'application/x-www-form-urlencoded'</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">'title'</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">'subtitle'</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  提交表单之后，通过控制台可以查看到下面信息：<br>  请求头（这里只给出了<code>Content-Type</code>字段）：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">    POST http://www.example.com HTTP/1.1</div><div class="line">    Content-Type: application/x-www-form-urlencoded</div></pre></td></tr></table></figure>
<p>  请求体：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">    title=test&amp;subtitle=%E4%B8%AD%E5%9B%BD</div></pre></td></tr></table></figure>
<p>  这里你看到的<code>%E4%B8%AD%E5%9B%BD</code>即是<code>中国</code>按照base64编码（url通用的编码方式）后的结果。可以在Chrome Console中通过<code>decodeURI(&#39;%E4%B8%AD%E5%9B%BD&#39;)</code>来解码。<br>  由此可见，<code>application/x-www-form-urlencoded</code>编码的格式就是参数使用<code>&amp;</code>符号连接，发送前对字符进行编码，空格会转换成”+”加号。</p>
</li>
<li>multipart编码<br>  multipart编码方式则需要设置<code>enctype</code>为<code>multipart/form-data</code>。当表单需要上传附件时，必须设置该编码。</li>
<li>text/plain编码<br>  除了<code>application/x-www-form-urlencoded</code>和<code>multipart/form-data</code>，HTML的<code>&lt;form&gt;</code>还支持<code>text/plain</code>。这种编码方式需要谨慎使用，Chrome使用与<code>application/x-www-form-urlencoded</code>一样的编码方案，而Firefox又不一样。</li>
</ul>
<h4 id="使用FormData对象发送表单数据"><a href="#使用FormData对象发送表单数据" class="headerlink" title="使用FormData对象发送表单数据"></a>使用FormData对象发送表单数据</h4><p>另一种更简洁的表单数据收集方式是使用一个FormData对象，它是在XMLHttpRequest第二级规范中定义的。</p>
<ul>
<li><p>创建FormData对象<br>  创建FormData对象可以传递一个HTMLFormElement对象，这样表单里的所有元素的值都会被自动收集起来。下面是综合例子：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">id</span>=<span class="string">"myForm"</span>&gt;</span></div><div class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"username"</span> /&gt;</span></div><div class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span>  /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"submitBtn"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">            <span class="keyword">var</span> httpRequest;</div><div class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"submitBtn"</span>).addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">                e.preventDefault();</div><div class="line">                <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">"myForm"</span>);</div><div class="line">                <span class="comment">//FormData对象默认的编码方式multipart/form-data;</span></div><div class="line">                <span class="keyword">var</span> formData = <span class="keyword">new</span> FormData(form);</div><div class="line">                <span class="comment">//还能添加参数</span></div><div class="line">                formData.append(<span class="string">"参数1"</span>,<span class="string">"谁看见啊"</span>);</div><div class="line">                httpRequest = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">                httpRequest.onreadystatechange = handleResponse;</div><div class="line">                httpRequest.open(<span class="string">'POST'</span>,form.action);</div><div class="line">                httpRequest.send(formData);</div><div class="line">            &#125;);</div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                <span class="built_in">console</span>.log(httpRequest.readyState);</div><div class="line">            &#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>发送JSON数据<br>  Ajax不止用来发送表单数据，几乎可以发送任何东西，运用最多的是JSON数据，下面是综合例子：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">id</span>=<span class="string">"myForm"</span>&gt;</span></div><div class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"username"</span> /&gt;</span></div><div class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span>  /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"submitBtn"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">            <span class="keyword">var</span> httpRequest;</div><div class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"submitBtn"</span>).addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">                e.preventDefault();</div><div class="line">                <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">"myForm"</span>);</div><div class="line">                <span class="keyword">var</span> inputElements = form.getElementsByTagName(<span class="string">"input"</span>);</div><div class="line">                <span class="keyword">var</span> formData = &#123;&#125;;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; inputElements.length ; i++)&#123;</div><div class="line">                    formData[inputElements[i].name] = inputElements[i].value;</div><div class="line">                &#125;</div><div class="line">                httpRequest = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">                httpRequest.onreadystatechange = handleResponse;</div><div class="line">                httpRequest.open(<span class="string">'POST'</span>,form.action);</div><div class="line">                httpRequest.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>);</div><div class="line">                httpRequest.send(<span class="built_in">JSON</span>.stringify(formData));</div><div class="line">            &#125;);</div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                <span class="built_in">console</span>.log(httpRequest.readyState);</div><div class="line">            &#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  <strong>注意：发送JSON数据需要设置Content-Type标头</strong><br>  用JSON对象JSON格式进行相互的转换。JSON对象提供了两个方法，如下表：<br>  <table><thead><tr><th>方法</th><th>说明</th><th>返回</th></tr></thead><tbody><tr><td>parse(str)</td><td>解析用JSON编码的字符串并创建一个JSON对象</td><td>对象</td></tr><tr><td>stringify(object)</td><td>把JSON格式的对象转换为字符串</td><td>字符串</td></tr></tbody></table>在例子中，我使用了stringify方法，然后传递给XMLHttpRequest对象的send方法。</p>
</li>
</ul>
<h3 id="发送文件"><a href="#发送文件" class="headerlink" title="发送文件"></a>发送文件</h3><p>可以使用FormData对象和type属性为file的input元素向服务器发送文件。<br><strong>注意：因为FormData对象是XMLHttpRequest第二级规范中定义的，所以有些老版本的浏览器并不支持，在没有FormData对象的浏览器里使用Ajax上传文件几乎不能实现。但有许多修补和变通的方法可供使用：Flash或者提交表单到隐藏的iframe里，这些方法都有较严重的缺陷，应谨慎使用。</strong><br>使用方法：在form表单添加类型为file的input元素，然后在脚本获取form元素作为参数传进FormData的构造方法，再把FormData对象作为参数传递给XMLHttpRequest的send方法。</p>
<h4 id="追踪文件上传进度"><a href="#追踪文件上传进度" class="headerlink" title="追踪文件上传进度"></a>追踪文件上传进度</h4><p>可以在数据发送到服务器时追踪它的进度。具体做法是使用XMLHTtpRequest对象的upload属性，该属性返回一个可用于监控进度的对象。<br>upload属性返回的XMLHttpRequest对象只定义了注册事件处理器所需的属性：onprogress和onload等。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">var</span> upload = httpRequest.upload;</div><div class="line">   upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">       <span class="built_in">console</span>.log(e.total,e.loaded);</div><div class="line">   &#125;</div><div class="line">   upload.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">       <span class="built_in">console</span>.log(<span class="string">"上传完成"</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="请求并处理不同内容类型（以JavaServlet为例）"><a href="#请求并处理不同内容类型（以JavaServlet为例）" class="headerlink" title="请求并处理不同内容类型（以JavaServlet为例）"></a>请求并处理不同内容类型（以JavaServlet为例）</h3><ul>
<li><p>返回HTML片段</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//返回html文档</span></div><div class="line">response.setContentType(<span class="string">"text/html;charset=utf-8"</span>);</div><div class="line">response.setHeader(<span class="string">"Cache-control"</span>, <span class="string">"no-cache"</span>);</div><div class="line">String res=<span class="string">"&lt;font size='2' color='blue'&gt;"</span>+name+pwd+<span class="string">"&lt;/font&gt;"</span>;</div><div class="line">PrintWriter out = response.getWriter();</div><div class="line">out.println(res);</div><div class="line">out.close();</div></pre></td></tr></table></figure>
<p>  <strong>可以用XMLHttpRequest对象的overrideMimeType方法指定服务器返回数据的MIME类型。该方法必须在<code>send()</code>之前调用。但这种方式较麻烦，在XMLHttpRequest版本升级以后，一般采用指定<code>responseType</code>的方法</strong></p>
</li>
<li><p>接收XML数据<br>  Servlet：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//返回xml文档</span></div><div class="line">response.setContentType(<span class="string">"text/xml;charset=utf-8"</span>);</div><div class="line">response.setHeader(<span class="string">"Cache-control"</span>, <span class="string">"no-cache"</span>);</div><div class="line">String res=<span class="string">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;"</span>+</div><div class="line">           <span class="string">"&lt;fruitorder total=\"27\"&gt;"</span>+</div><div class="line">		    <span class="string">"&lt;/fruitorder&gt;"</span>;</div><div class="line">PrintWriter out = response.getWriter();</div><div class="line">out.println(res);</div><div class="line">out.close();</div></pre></td></tr></table></figure>
<p>  HTML：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(httpRequest.readyState==<span class="number">4</span> &amp;&amp; httpRequest.status==<span class="number">200</span>)&#123;</div><div class="line">	    <span class="comment">//httpRequest.overrideMimeType("application/xml");这句要在send方法之前调用</span></div><div class="line">		<span class="keyword">var</span> xmlDoc = httpRequest.responseXML;</div><div class="line">		<span class="keyword">var</span> total = xmlDoc.getElementsByTagName(<span class="string">"fruitorder"</span>)[<span class="number">0</span>].getAttribute(<span class="string">'total'</span>);</div><div class="line">		<span class="built_in">console</span>.log(total);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接收JSON数据<br>  Servlet需要设置<code>response.setContentType(&quot;application/json; charset=utf-8&quot;);</code>向页面输出JSON格式的字符串，前端页面需要使用JSON对象的parse方法解析成JSON对象。</p>
</li>
</ul>
<h3 id="response属性和responseType属性"><a href="#response属性和responseType属性" class="headerlink" title="response属性和responseType属性"></a>response属性和responseType属性</h3><p>response和responseType是XMLHttpRequest二级规范定义的属性，使用它们可以指定服务器返回的数据类型，并进行自动转换<br><code>responseType</code>属性用来指定服务器返回数据（<code>xhr.response</code>）的类型。取值如下：<table><tr><td>值</td><td>说明</td></tr><tr></tr><tr><td>‘’(空字符串)</td><td>response属性返回字符串（默认）</td></tr><td>text</td><td>response属性返回字符串</td><tr><td>arraybuffer</td><td>response属性返回ArrayBuffer对象</td></tr><tr><td>blob</td><td>response属性返回Bolb对象</td></tr><tr><td>document</td><td>response属性返回Document对象</td></tr><tr><td>json</td><td>response属性返回JSON对象</td></tr></table><br>text类型适合大多数情况，而且直接处理文本也比较方便，document类型适合返回XML或HTML文档的情况，blob类型适合读取二进制数据，比如图片文件。如果将这个属性设为“json”，支持JSON的浏览器（Firefox&gt;9，chrome&gt;30），就会自动对返回数据调用<code>JSON.parse()</code>方法。下面是例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'/path/to/image.png'</span>, <span class="literal">true</span>);</div><div class="line">xhr.responseType = <span class="string">'blob'</span>;</div><div class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</div><div class="line">    <span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([<span class="keyword">this</span>.response], &#123;type: <span class="string">'image/png'</span>&#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">xhr.send();</div></pre></td></tr></table></figure></p>


            <div class="post-info">
    <p class="link">本文链接：<a href="https://heji1993.github.io/2016/12/28/Ajax/">https://heji1993.github.io/2016/12/28/Ajax/</a></p>
    <div class="share">
    分享本页：
    
        <div class="bdsharebuttonbox"><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a><a href="#" class="bds_more" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

    
    
</div>

</div>


            
    <section class="comment">
    <div class="ds-thread" data-thread-key="undefined" data-title="Ajax" data-url="https://heji1993.github.io/2016/12/28/Ajax/" data-author-key="何机"></div>
</section>


<script type="text/javascript">
var duoshuoQuery = {short_name:"heji"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>





        </div>
    </div>
</article>

    <footer id="footer">
        <div id="bottom-tip">
            何机的博客 —— <small>No pains,no gains</small>
        </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载 <a href="https://github.com/gejiawen/hexadillax2" target="_blank">Hexadillax2</a> 主题</small><br />
        <!--<small>如果你访问github速度过慢，可移步本站的备份站点<a href="http://gejiawen.gitcafe.io">gejiawen.gitcafe.io</a></small><br />-->
        <small>&copy; 2016 <a href="https://heji1993.github.io" target="_blank">何机</a></small>
    </footer>
    
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e4dd778a6204eb51e4f25460e37481ad";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=58628762" charset="UTF-8"></script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-51347904-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>

